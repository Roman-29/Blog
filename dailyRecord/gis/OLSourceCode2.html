<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OpenLayers æºç åˆ†æ(ä¸‹ç¯‡) | Roman&#39;s Notebook</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/Blog/images/logo.png">
    <meta name="description" content="ğŸ“æ¯å¤©è®°å½•ä¸€ç‚¹ç‚¹">
    
    <link rel="preload" href="/Blog/assets/css/0.styles.97ce9fae.css" as="style"><link rel="preload" href="/Blog/assets/js/app.d6f4b6a2.js" as="script"><link rel="preload" href="/Blog/assets/js/2.fd75a44f.js" as="script"><link rel="preload" href="/Blog/assets/js/9.e1456e0e.js" as="script"><link rel="prefetch" href="/Blog/assets/js/10.ef8ad2af.js"><link rel="prefetch" href="/Blog/assets/js/11.6c4cb71a.js"><link rel="prefetch" href="/Blog/assets/js/12.bf292e9a.js"><link rel="prefetch" href="/Blog/assets/js/13.27d3af28.js"><link rel="prefetch" href="/Blog/assets/js/14.c90a7c8e.js"><link rel="prefetch" href="/Blog/assets/js/15.d1fb7a7e.js"><link rel="prefetch" href="/Blog/assets/js/16.090affc6.js"><link rel="prefetch" href="/Blog/assets/js/17.4e5df8a3.js"><link rel="prefetch" href="/Blog/assets/js/18.db68a2d0.js"><link rel="prefetch" href="/Blog/assets/js/19.78ffae18.js"><link rel="prefetch" href="/Blog/assets/js/20.326bfd19.js"><link rel="prefetch" href="/Blog/assets/js/21.4bc7c7af.js"><link rel="prefetch" href="/Blog/assets/js/22.d5f7595c.js"><link rel="prefetch" href="/Blog/assets/js/23.e48ece5c.js"><link rel="prefetch" href="/Blog/assets/js/24.4c1ca19a.js"><link rel="prefetch" href="/Blog/assets/js/25.97fa940f.js"><link rel="prefetch" href="/Blog/assets/js/26.acb8e14e.js"><link rel="prefetch" href="/Blog/assets/js/27.4233a341.js"><link rel="prefetch" href="/Blog/assets/js/28.a2ff22a3.js"><link rel="prefetch" href="/Blog/assets/js/29.6016abd9.js"><link rel="prefetch" href="/Blog/assets/js/3.c01d88b2.js"><link rel="prefetch" href="/Blog/assets/js/30.61781442.js"><link rel="prefetch" href="/Blog/assets/js/31.c4b84ed1.js"><link rel="prefetch" href="/Blog/assets/js/32.e426325a.js"><link rel="prefetch" href="/Blog/assets/js/33.90e060c3.js"><link rel="prefetch" href="/Blog/assets/js/34.7059796b.js"><link rel="prefetch" href="/Blog/assets/js/35.53956048.js"><link rel="prefetch" href="/Blog/assets/js/36.b2e386ad.js"><link rel="prefetch" href="/Blog/assets/js/37.8918b02a.js"><link rel="prefetch" href="/Blog/assets/js/38.16fe91ea.js"><link rel="prefetch" href="/Blog/assets/js/39.1a8073b2.js"><link rel="prefetch" href="/Blog/assets/js/4.accf9f2c.js"><link rel="prefetch" href="/Blog/assets/js/40.3383d598.js"><link rel="prefetch" href="/Blog/assets/js/41.85fae2a9.js"><link rel="prefetch" href="/Blog/assets/js/42.0404369c.js"><link rel="prefetch" href="/Blog/assets/js/43.bde5e9e5.js"><link rel="prefetch" href="/Blog/assets/js/44.babab1d1.js"><link rel="prefetch" href="/Blog/assets/js/45.3fa179d9.js"><link rel="prefetch" href="/Blog/assets/js/46.b3b4f85b.js"><link rel="prefetch" href="/Blog/assets/js/47.6759b2e2.js"><link rel="prefetch" href="/Blog/assets/js/48.64cdfd94.js"><link rel="prefetch" href="/Blog/assets/js/49.d58826b4.js"><link rel="prefetch" href="/Blog/assets/js/5.422be1ef.js"><link rel="prefetch" href="/Blog/assets/js/6.12713950.js"><link rel="prefetch" href="/Blog/assets/js/7.7a16dec8.js"><link rel="prefetch" href="/Blog/assets/js/8.10f0167f.js">
    <link rel="stylesheet" href="/Blog/assets/css/0.styles.97ce9fae.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Blog/" class="home-link router-link-active"><!----> <span class="site-name">Roman's Notebook</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Blog/dailyRecord/" class="nav-link router-link-active">
  ğŸ“šå­¦ä¹ æ€»ç»“
</a></div><div class="nav-item"><a href="/Blog/bookmark/" class="nav-link">
  ğŸ“Œä¹¦ç­¾æ•´ç†
</a></div><div class="nav-item"><a href="/Blog/lint/" class="nav-link">
  âœ”ï¸ç¼–ç è§„èŒƒ&amp;ååŒå¼€å‘
</a></div><div class="nav-item"><a href="http://shooterblog.site/Learn-JS-Demo/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ğŸ“–çŸ¥è¯†è„‘å›¾
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/Roman-29" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ğŸ”—Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Blog/dailyRecord/" class="nav-link router-link-active">
  ğŸ“šå­¦ä¹ æ€»ç»“
</a></div><div class="nav-item"><a href="/Blog/bookmark/" class="nav-link">
  ğŸ“Œä¹¦ç­¾æ•´ç†
</a></div><div class="nav-item"><a href="/Blog/lint/" class="nav-link">
  âœ”ï¸ç¼–ç è§„èŒƒ&amp;ååŒå¼€å‘
</a></div><div class="nav-item"><a href="http://shooterblog.site/Learn-JS-Demo/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ğŸ“–çŸ¥è¯†è„‘å›¾
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/Roman-29" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ğŸ”—Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue3æºç </span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å•å…ƒæµ‹è¯•</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>GIS</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Blog/dailyRecord/gis/OpenLayers.html" class="sidebar-link">OpenLayers åŸºç¡€</a></li><li><a href="/Blog/dailyRecord/gis/OLSourceCode1.html" class="sidebar-link">OpenLayers æºç åˆ†æ(ä¸Šç¯‡)</a></li><li><a href="/Blog/dailyRecord/gis/OLSourceCode2.html" aria-current="page" class="active sidebar-link">OpenLayers æºç åˆ†æ(ä¸‹ç¯‡)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Blog/dailyRecord/gis/OLSourceCode2.html#ç®€ä»‹" class="sidebar-link">ç®€ä»‹</a></li><li class="sidebar-sub-header"><a href="/Blog/dailyRecord/gis/OLSourceCode2.html#source" class="sidebar-link">Source</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Blog/dailyRecord/gis/OLSourceCode2.html#æ•°æ®æº" class="sidebar-link">æ•°æ®æº</a></li><li class="sidebar-sub-header"><a href="/Blog/dailyRecord/gis/OLSourceCode2.html#å•å¼ å›¾ç‰‡-ol-source-image" class="sidebar-link">å•å¼ å›¾ç‰‡(ol/source/Image)</a></li><li class="sidebar-sub-header"><a href="/Blog/dailyRecord/gis/OLSourceCode2.html#ç“¦ç‰‡å›¾ç‰‡-ol-source-tile" class="sidebar-link">ç“¦ç‰‡å›¾ç‰‡(ol/source/Tile)</a></li><li class="sidebar-sub-header"><a href="/Blog/dailyRecord/gis/OLSourceCode2.html#çŸ¢é‡æ•°æ®-ol-source-vector" class="sidebar-link">çŸ¢é‡æ•°æ®(ol/source/Vector)</a></li><li class="sidebar-sub-header"><a href="/Blog/dailyRecord/gis/OLSourceCode2.html#source-change" class="sidebar-link">Source change</a></li><li class="sidebar-sub-header"><a href="/Blog/dailyRecord/gis/OLSourceCode2.html#view-change" class="sidebar-link">View change</a></li></ul></li><li class="sidebar-sub-header"><a href="/Blog/dailyRecord/gis/OLSourceCode2.html#æ€»ç»“" class="sidebar-link">æ€»ç»“</a></li></ul></li><li><a href="/Blog/dailyRecord/gis/ArcgisAPI.html" class="sidebar-link">Arcgis API</a></li><li><a href="/Blog/dailyRecord/gis/GISsystem.html" class="sidebar-link">GIS ä½“ç³»ä»‹ç»</a></li><li><a href="/Blog/dailyRecord/gis/SuperMapWebGL.html" class="sidebar-link">SuperMap iClient 3D for WebGL</a></li><li><a href="/Blog/dailyRecord/gis/SuperMap3DStudy.html" class="sidebar-link">ä¸‰ç»´ WebGIS å­¦ä¹ ç¬”è®°</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å‰ç«¯æ¨¡å—åŒ–å’Œæ‰“åŒ…å·¥å…·</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å†…åŠŸä¿®ç‚¼</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å‰ç«¯å¼‚å¸¸ç›‘æ§</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>æ€»ç»“</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å…¶ä»–</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="openlayers-æºç åˆ†æ-ä¸‹ç¯‡"><a href="#openlayers-æºç åˆ†æ-ä¸‹ç¯‡" class="header-anchor">#</a> OpenLayers æºç åˆ†æ(ä¸‹ç¯‡)</h1> <h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="header-anchor">#</a> ç®€ä»‹</h2> <p>æœ¬ç¯‡ä»‹ç» openlayers æºç ä¸­çš„ source éƒ¨åˆ†</p> <h2 id="source"><a href="#source" class="header-anchor">#</a> Source</h2> <p>ä» openlayers å®˜ç½‘é¦–é¡µæˆ‘ä»¬å¯ä»¥çœ‹åˆ°, openlayers æœ¬èº«æ”¯æŒè¶…å¤šç§ç±»çš„æ•°æ®æ¥æºä½œä¸ºå›¾å±‚åŠ è½½åˆ°åœ°å›¾ä¸Š, è¿™å¾—ç›Šäº openlayers å¯ä»¥è‡ªç”±çš„æ‹“å±• Source ç±».</p> <p><img src="/Blog/assets/img/01.9699c5a1.png" alt="image"></p> <p>ä»æºç çš„åˆ†ææ¥çœ‹, æˆ‘ä»¬å¯ä»¥å¯¹ Source åˆ†ä¸ºä¸‰ç±»:</p> <ol><li>å•å¼ å›¾ç‰‡ ol/source/Image</li> <li>ç“¦ç‰‡å›¾ç‰‡ ol/source/Tile</li> <li>çŸ¢é‡å›¾ç‰‡ ol/source/Vector</li></ol> <h3 id="æ•°æ®æº"><a href="#æ•°æ®æº" class="header-anchor">#</a> æ•°æ®æº</h3> <p>ol/source/Source æ˜¯æŠ½è±¡åŸºç±», ä¸è¢«å®ä¾‹åŒ–, å…¶å­ç±»å°±æ˜¯ä¸Šé¢æåˆ°çš„ä¸‰ä¸ªç±», æ‰€ä»¥æˆ‘ä»¬åˆ†ææºç çš„æ—¶å€™ä¹Ÿåˆ†æˆè¿™ä¸‰ç±»åˆ†åˆ«å»å­¦ä¹ ç ”ç©¶.</p> <p>çˆ¶ç±»æ˜¯ ol/Object. è¿™æ˜¯åŸºç±»ä¸­çš„åŸºç±», è¿™ç§åŸºä¸­åŸºä¸€èˆ¬éƒ½æ˜¯å®šä¹‰æœ€é€šç”¨çš„å‡½æ•°, ä¸ä¼šæœ‰ä¸šåŠ¡é€»è¾‘. æ‰€ä»¥æˆ‘ä»¬ç›´æ¥ä» Source å¼€å§‹çœ‹å°±å¯ä»¥äº†.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ol/source/Source.js å…³é”®ä»£ç </span>

<span class="token keyword">class</span> <span class="token class-name">Source</span> <span class="token keyword">extends</span> <span class="token class-name">BaseObject</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>projection_ <span class="token operator">=</span> <span class="token function">getProjection</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>projection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>attributions_ <span class="token operator">=</span> <span class="token function">adaptAttributions</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>attributions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>attributionsCollapsible_ <span class="token operator">=</span>
      options<span class="token punctuation">.</span>attributionsCollapsible <span class="token operator">!==</span> <span class="token keyword">undefined</span>
        <span class="token operator">?</span> options<span class="token punctuation">.</span>attributionsCollapsible
        <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// sourceçš„çŠ¶æ€, é»˜è®¤æ˜¯ready</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state_ <span class="token operator">=</span>
      options<span class="token punctuation">.</span>state <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> options<span class="token punctuation">.</span>state <span class="token operator">:</span> SourceState<span class="token punctuation">.</span><span class="token constant">READY</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>wrapX_ <span class="token operator">=</span> options<span class="token punctuation">.</span>wrapX <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> options<span class="token punctuation">.</span>wrapX <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// åˆ·æ–°source, sourceä¼šè¢«æ¸…ç©º, æ•°æ®ä¼šé‡æ–°åŠ è½½</span>
  <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">changed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°, è¿™éƒ¨åˆ†ä»£ç é‡éå¸¸å°‘, é™¤äº† state è®¾ç½®ä¸º ready, å¹¶æ²¡æœ‰å¤ªå¤šå½±å“åˆ°ä¸šåŠ¡çš„ä»£ç éƒ¨åˆ†</p> <h3 id="å•å¼ å›¾ç‰‡-ol-source-image"><a href="#å•å¼ å›¾ç‰‡-ol-source-image" class="header-anchor">#</a> å•å¼ å›¾ç‰‡(ol/source/Image)</h3> <p>ç›¸å…³çš„å­ç±»å°±éå¸¸å¤šäº†:</p> <ol><li>ol/source/ImageArcGISRest</li> <li>ol/source/ImageCanvas</li> <li>ol/source/ImageMapGuide</li> <li>ol/source/ImageStatic</li> <li>ol/source/ImageWMS</li> <li>ol/source/Raster</li></ol> <p>å†åšç»†åˆ†, å¯ä»¥å°† ArcGIS, WMS, MapGuide, Static åˆ†ä¸ºä¸€ç±», å…¶åŸç†éƒ½æ˜¯æ ¹æ®å›¾ç‰‡çš„ URL, æ‹¿åˆ°å›¾ç‰‡æ•°æ®, ç”Ÿæˆ canvas ç»˜åˆ¶åˆ°åœ°å›¾ä¸Š. canvas å’Œ raster åˆ†ä¸ºå¦ä¸€ç±», è¿™ä¸€ç±»æ¯”è¾ƒå¤æ‚, æ˜¯éœ€è¦æ ¹æ®éå›¾ç‰‡æ•°æ®è¿›è¡Œ canvas ç»˜åˆ¶.</p> <p>æˆ‘ä»¬ä¸»è¦åˆ†æç¬¬ä¸€ç±», æ‹¿åˆ°å›¾ç‰‡æ•°æ®å»åšå›¾å±‚åŠ è½½, è¿™ä¹Ÿæ˜¯æˆ‘ä»¬å¸¸ç”¨çš„å›¾å±‚åŠ è½½æ–¹å¼.</p> <p>UML å›¾:</p> <p><img src="/Blog/assets/img/02.3d7ac214.png" alt="image"></p> <h4 id="ol-source-image"><a href="#ol-source-image" class="header-anchor">#</a> ol/source/Image</h4> <p>æŠ½è±¡åŸºç±», å®šä¹‰äº† getImage å‡½æ•°å’Œ handleImageChange å‡½æ•°, å…·ä½“æ˜¯å¦‚ä½•ç”Ÿæˆ image åˆ™éœ€è¦å­ç±»é‡è½½</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ol/source/Image.js å…³é”®ä»£ç </span>

<span class="token keyword">class</span> <span class="token class-name">ImageSource</span> <span class="token keyword">extends</span> <span class="token class-name">Source</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      attributions<span class="token operator">:</span> options<span class="token punctuation">.</span>attributions<span class="token punctuation">,</span>
      projection<span class="token operator">:</span> options<span class="token punctuation">.</span>projection<span class="token punctuation">,</span>
      state<span class="token operator">:</span> options<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// åˆ†è¾¨ç‡</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resolutions_ <span class="token operator">=</span>
      options<span class="token punctuation">.</span>resolutions <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> options<span class="token punctuation">.</span>resolutions <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token operator">...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// è·å–å›¾ç‰‡æ–¹æ³•</span>
  <span class="token function">getImage</span><span class="token punctuation">(</span><span class="token parameter">extent<span class="token punctuation">,</span> resolution<span class="token punctuation">,</span> pixelRatio<span class="token punctuation">,</span> projection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> sourceProjection <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getProjection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ¤æ–­åæ ‡ç³»æ˜¯å¦éœ€è¦è½¬æ¢</span>
    <span class="token comment">// projectionå‚æ•°æŒ‡çš„æ˜¯viewçš„projection</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token operator">!</span><span class="token constant">ENABLE_RASTER_REPROJECTION</span> <span class="token operator">||</span>
      <span class="token operator">!</span>sourceProjection <span class="token operator">||</span>
      <span class="token operator">!</span>projection <span class="token operator">||</span>
      <span class="token function">equivalent</span><span class="token punctuation">(</span>sourceProjection<span class="token punctuation">,</span> projection<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceProjection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        projection <span class="token operator">=</span> sourceProjection<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getImageInternal</span><span class="token punctuation">(</span>extent<span class="token punctuation">,</span> resolution<span class="token punctuation">,</span> pixelRatio<span class="token punctuation">,</span> projection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// æŠ½è±¡æ–¹æ³•, å…·ä½“å¦‚ä½•å®ç°åœ¨å­ç±»</span>
  <span class="token function">getImageInternal</span><span class="token punctuation">(</span><span class="token parameter">extent<span class="token punctuation">,</span> resolution<span class="token punctuation">,</span> pixelRatio<span class="token punctuation">,</span> projection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">abstract</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ç›‘å¬ image æ”¹å˜äº‹ä»¶.</span>
  <span class="token function">handleImageChange</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token comment">/** @type {import(&quot;../Image.js&quot;).default} */</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>image<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> ImageState<span class="token punctuation">.</span><span class="token constant">LOADING</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>
          <span class="token keyword">new</span> <span class="token class-name">ImageSourceEvent</span><span class="token punctuation">(</span>ImageSourceEventType<span class="token punctuation">.</span><span class="token constant">IMAGELOADSTART</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> ImageState<span class="token punctuation">.</span><span class="token constant">LOADED</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>
          <span class="token keyword">new</span> <span class="token class-name">ImageSourceEvent</span><span class="token punctuation">(</span>ImageSourceEventType<span class="token punctuation">.</span><span class="token constant">IMAGELOADEND</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> ImageState<span class="token punctuation">.</span><span class="token constant">ERROR</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>
          <span class="token keyword">new</span> <span class="token class-name">ImageSourceEvent</span><span class="token punctuation">(</span>ImageSourceEventType<span class="token punctuation">.</span><span class="token constant">IMAGELOADERROR</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token comment">// pass</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="ol-source-imagearcgisrest"><a href="#ol-source-imagearcgisrest" class="header-anchor">#</a> ol/source/ImageArcGISRest</h4> <p>å†çœ‹çœ‹ arcgis, ä¹Ÿæ˜¯æˆ‘ä»¬æœ€å¸¸ç”¨çš„ç±»ä¹‹ä¸€</p> <p>ä¸»è¦å†…å®¹æ˜¯æ ¹æ® arcgis server çš„è¯·æ±‚å‚æ•°å¯¹ getImageInternal å‡½æ•°è¿›è¡Œé‡è½½</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ol/source/ImageArcGISRest å…³é”®ä»£ç </span>

<span class="token keyword">class</span> <span class="token class-name">ImageArcGISRest</span> <span class="token keyword">extends</span> <span class="token class-name">ImageSource</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * @param {Options=} opt_options Image ArcGIS Rest Options.
   */</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">opt_options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> options <span class="token operator">=</span> opt_options <span class="token operator">?</span> opt_options <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      attributions<span class="token operator">:</span> options<span class="token punctuation">.</span>attributions<span class="token punctuation">,</span>
      imageSmoothing<span class="token operator">:</span> options<span class="token punctuation">.</span>imageSmoothing<span class="token punctuation">,</span>
      projection<span class="token operator">:</span> options<span class="token punctuation">.</span>projection<span class="token punctuation">,</span>
      resolutions<span class="token operator">:</span> options<span class="token punctuation">.</span>resolutions<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>url_ <span class="token operator">=</span> options<span class="token punctuation">.</span>url<span class="token punctuation">;</span>

    <span class="token comment">// imageåŠ è½½æ–¹æ³•, å¦‚æœä¸ºå®šä¹‰åˆ™ä½¿ç”¨é»˜è®¤æ–¹æ³•</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>imageLoadFunction_ <span class="token operator">=</span>
      options<span class="token punctuation">.</span>imageLoadFunction <span class="token operator">!==</span> <span class="token keyword">undefined</span>
        <span class="token operator">?</span> options<span class="token punctuation">.</span>imageLoadFunction
        <span class="token operator">:</span> defaultImageLoadFunction<span class="token punctuation">;</span>

    <span class="token comment">// arcgisè¯·æ±‚åœ°å›¾çš„å‚æ•°</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>params_ <span class="token operator">=</span> options<span class="token punctuation">.</span>params <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// å­˜å‚¨å›¾ç‰‡</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>image_ <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// å›¾ç‰‡å¤§å°</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>imageSize_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token operator">...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// å®ç°çˆ¶ç±»æ–¹æ³•, å®ä¾‹åŒ– ol/Imageç±»</span>
  <span class="token function">getImageInternal</span><span class="token punctuation">(</span><span class="token parameter">extent<span class="token punctuation">,</span> resolution<span class="token punctuation">,</span> pixelRatio<span class="token punctuation">,</span> projection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>url_ <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    resolution <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findNearestResolution</span><span class="token punctuation">(</span>resolution<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pixelRatio <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hidpi_ <span class="token operator">?</span> pixelRatio <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>image_<span class="token punctuation">;</span>
    <span class="token comment">// æ£€æŸ¥æ˜¯å¦å·²æœ‰image, ä¸”å…³é”®å‚æ•°æœªä¿®æ”¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      image <span class="token operator">&amp;&amp;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>renderedRevision_ <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRevision</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      image<span class="token punctuation">.</span><span class="token function">getResolution</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> resolution <span class="token operator">&amp;&amp;</span>
      image<span class="token punctuation">.</span><span class="token function">getPixelRatio</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> pixelRatio <span class="token operator">&amp;&amp;</span>
      <span class="token function">containsExtent</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span><span class="token function">getExtent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> extent<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> image<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// arcgis åœ°å›¾æœåŠ¡çš„å‚æ•°</span>
    <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token string">'F'</span><span class="token operator">:</span> <span class="token string">'image'</span><span class="token punctuation">,</span>
      <span class="token string">'FORMAT'</span><span class="token operator">:</span> <span class="token string">'PNG32'</span><span class="token punctuation">,</span>
      <span class="token string">'TRANSPARENT'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">assign</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>params_<span class="token punctuation">)</span><span class="token punctuation">;</span>

    extent <span class="token operator">=</span> extent<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> centerX <span class="token operator">=</span> <span class="token punctuation">(</span>extent<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> extent<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> centerY <span class="token operator">=</span> <span class="token punctuation">(</span>extent<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> extent<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ratio_ <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> halfWidth <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ratio_ <span class="token operator">*</span> <span class="token function">getWidth</span><span class="token punctuation">(</span>extent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> halfHeight <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ratio_ <span class="token operator">*</span> <span class="token function">getHeight</span><span class="token punctuation">(</span>extent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
      extent<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> centerX <span class="token operator">-</span> halfWidth<span class="token punctuation">;</span>
      extent<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> centerY <span class="token operator">-</span> halfHeight<span class="token punctuation">;</span>
      extent<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> centerX <span class="token operator">+</span> halfWidth<span class="token punctuation">;</span>
      extent<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> centerY <span class="token operator">+</span> halfHeight<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> imageResolution <span class="token operator">=</span> resolution <span class="token operator">/</span> pixelRatio<span class="token punctuation">;</span>

    <span class="token comment">// è®¡ç®—å›¾ç‰‡çš„å®½é«˜.</span>
    <span class="token keyword">const</span> width <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token function">getWidth</span><span class="token punctuation">(</span>extent<span class="token punctuation">)</span> <span class="token operator">/</span> imageResolution<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> height <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token function">getHeight</span><span class="token punctuation">(</span>extent<span class="token punctuation">)</span> <span class="token operator">/</span> imageResolution<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å›¾ç‰‡åœ°ç†èŒƒå›´.</span>
    extent<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> centerX <span class="token operator">-</span> <span class="token punctuation">(</span>imageResolution <span class="token operator">*</span> width<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    extent<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> centerX <span class="token operator">+</span> <span class="token punctuation">(</span>imageResolution <span class="token operator">*</span> width<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    extent<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> centerY <span class="token operator">-</span> <span class="token punctuation">(</span>imageResolution <span class="token operator">*</span> height<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    extent<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> centerY <span class="token operator">+</span> <span class="token punctuation">(</span>imageResolution <span class="token operator">*</span> height<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>imageSize_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> width<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>imageSize_<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> height<span class="token punctuation">;</span>

    <span class="token comment">// é€šè¿‡æ‰€æœ‰çš„å‚æ•°æ‹¼æ¥ä¸€ä¸ªURL</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRequestUrl_</span><span class="token punctuation">(</span>
      extent<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>imageSize_<span class="token punctuation">,</span>
      pixelRatio<span class="token punctuation">,</span>
      projection<span class="token punctuation">,</span>
      params
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å¾—åˆ°äº†ä¸€ä¸ªImageWrapperç±»(ol/Image), åé¢å¦‚ä½•å¯¹å›¾ç‰‡è¯·æ±‚, è¯·æ±‚å®Œåå¦‚ä½•æ¸²æŸ“å°±å’Œä»–æœ‰å…³ç³»äº†</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>image_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImageWrapper</span><span class="token punctuation">(</span>
      extent<span class="token punctuation">,</span>
      resolution<span class="token punctuation">,</span>
      pixelRatio<span class="token punctuation">,</span>
      url<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>crossOrigin_<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>imageLoadFunction_
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>renderedRevision_ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRevision</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ç›‘å¬image å›è°ƒå‡½æ•°å°±æ˜¯çˆ¶ç±»çš„handleImageChange</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>image_<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
      EventType<span class="token punctuation">.</span><span class="token constant">CHANGE</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleImageChange</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>image_<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token comment">// æ‹¼æ¥arcgisåœ°å›¾æœåŠ¡ URL</span>
  <span class="token function">getRequestUrl_</span><span class="token punctuation">(</span><span class="token parameter">extent<span class="token punctuation">,</span> size<span class="token punctuation">,</span> pixelRatio<span class="token punctuation">,</span> projection<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ArcGIS Server only wants the numeric portion of the projection ID.</span>
    <span class="token keyword">const</span> srid <span class="token operator">=</span> projection<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    params<span class="token punctuation">[</span><span class="token string">'SIZE'</span><span class="token punctuation">]</span> <span class="token operator">=</span> size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">','</span> <span class="token operator">+</span> size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    params<span class="token punctuation">[</span><span class="token string">'BBOX'</span><span class="token punctuation">]</span> <span class="token operator">=</span> extent<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    params<span class="token punctuation">[</span><span class="token string">'BBOXSR'</span><span class="token punctuation">]</span> <span class="token operator">=</span> srid<span class="token punctuation">;</span>
    params<span class="token punctuation">[</span><span class="token string">'IMAGESR'</span><span class="token punctuation">]</span> <span class="token operator">=</span> srid<span class="token punctuation">;</span>
    params<span class="token punctuation">[</span><span class="token string">'DPI'</span><span class="token punctuation">]</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token number">90</span> <span class="token operator">*</span> pixelRatio<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>url_<span class="token punctuation">;</span>

    <span class="token keyword">const</span> modifiedUrl <span class="token operator">=</span> url
      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">MapServer\/?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'MapServer/export'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">ImageServer\/?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'ImageServer/exportImage'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>modifiedUrl <span class="token operator">==</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">assert</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// `options.featureTypes` should be an Array</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">appendParams</span><span class="token punctuation">(</span>modifiedUrl<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="ol-image"><a href="#ol-image" class="header-anchor">#</a> ol/image</h4> <p>getImageInternal å‡½æ•°å¾—åˆ°çš„ ImageWrapper å¦‚æœ state ä¸º IDLE ä¼šè¢«è°ƒç”¨ load æ–¹æ³•, ç„¶åç›‘å¬ image æ ‡ç­¾æ˜¯å¦åŠ è½½åˆ°äº†å›¾ç‰‡æ•°æ®, å½“åŠ è½½å®Œæˆçš„æ—¶å€™è§¦å‘ change å‡½æ•°.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">ImageWrapper</span> <span class="token keyword">extends</span> <span class="token class-name">ImageBase</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>src_ <span class="token operator">=</span> src<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>image_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>

  <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">==</span> ImageState<span class="token punctuation">.</span><span class="token constant">IDLE</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">==</span> ImageState<span class="token punctuation">.</span><span class="token constant">ERROR</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> ImageState<span class="token punctuation">.</span><span class="token constant">LOADING</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">changed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">imageLoadFunction_</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>src_<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>unlisten_ <span class="token operator">=</span> <span class="token function">listenImage</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>image_<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleImageLoad_</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleImageError_</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">handleImageLoad_</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolution <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>resolution <span class="token operator">=</span> <span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>extent<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>image_<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> ImageState<span class="token punctuation">.</span><span class="token constant">LOADED</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unlistenImage_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">changed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">listenImage</span><span class="token punctuation">(</span><span class="token parameter">image<span class="token punctuation">,</span> loadHandler<span class="token punctuation">,</span> errorHandler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> img <span class="token operator">=</span> <span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>img<span class="token punctuation">.</span>src <span class="token operator">&amp;&amp;</span> <span class="token constant">IMAGE_DECODE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> promise <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> listening <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">unlisten</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      listening <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    promise
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>listening<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">loadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>listening<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>
            error<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'EncodingError'</span> <span class="token operator">&amp;&amp;</span>
            error<span class="token punctuation">.</span>message <span class="token operator">===</span> <span class="token string">'Invalid image type.'</span>
          <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">loadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">errorHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> unlisten<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> listenerKeys <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token function">listenOnce</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> EventType<span class="token punctuation">.</span><span class="token constant">LOAD</span><span class="token punctuation">,</span> loadHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">listenOnce</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> EventType<span class="token punctuation">.</span><span class="token constant">ERROR</span><span class="token punctuation">,</span> errorHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">unlisten</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    listenerKeys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>unlistenByKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="imagewms-imagestatic-ç­‰"><a href="#imagewms-imagestatic-ç­‰" class="header-anchor">#</a> ImageWMS/ImageStatic ç­‰</h4> <p>å†çœ‹çœ‹å’Œ ImageArcGISRest å¹³çº§çš„ ImageWMS/ImageStatic ç±», ä¼šå‘ç°é€»è¾‘è¿‘ä¹ä¸€æ ·, æ ¸å¿ƒéƒ½åœ¨ getImageInternal é‡Œé¢</p> <p>åŸºæœ¬æµç¨‹: æ˜¯å¦å·²åŠ è½½ -&gt; å¦åˆ™å‡†å¤‡å¥½å„ç§å‚æ•° -&gt; æ„é€ è¯·æ±‚ URL -&gt; load</p> <p>ç®€å•æ¥è¯´, å°±æ˜¯å¯¹ç°æœ‰çš„æœåŠ¡è¯·æ±‚åšä¸€ä¸ªå°è£…</p> <h3 id="ç“¦ç‰‡å›¾ç‰‡-ol-source-tile"><a href="#ç“¦ç‰‡å›¾ç‰‡-ol-source-tile" class="header-anchor">#</a> ç“¦ç‰‡å›¾ç‰‡(ol/source/Tile)</h3> <p>ç›¸å¯¹äºå•å¼ å›¾ç‰‡, ç“¦ç‰‡å›¾ç‰‡éœ€è¦æ›´åŠ ç²¾ç»†çš„å¯¹æ¯ä¸€ä¸ªå›¾ç‰‡åšæ§åˆ¶, æ‰èƒ½æŠŠå°å›¾ç‰‡æ‹¼æ¥æˆä¸€ä¸ªå¤§å›¾ç‰‡, æ‰€ä»¥ä¼šç”¨åˆ° tileGrid(åˆ‡ç‰‡æ ¼ç½‘)å’Œ tileCache(åˆ‡ç‰‡ç¼“å­˜)</p> <p>UML å›¾:</p> <p><img src="/Blog/assets/img/03.712c8edc.png" alt="image"></p> <h4 id="ol-source-tile"><a href="#ol-source-tile" class="header-anchor">#</a> ol/source/Tile</h4> <p>åˆ›å»º tileGrid å’Œ tileCache</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ol/source/Tile.js å…³é”®ä»£ç </span>

<span class="token keyword">class</span> <span class="token class-name">TileSource</span> <span class="token keyword">extends</span> <span class="token class-name">Source</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      attributions<span class="token operator">:</span> options<span class="token punctuation">.</span>attributions<span class="token punctuation">,</span>
      attributionsCollapsible<span class="token operator">:</span> options<span class="token punctuation">.</span>attributionsCollapsible<span class="token punctuation">,</span>
      projection<span class="token operator">:</span> options<span class="token punctuation">.</span>projection<span class="token punctuation">,</span>
      state<span class="token operator">:</span> options<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
      wrapX<span class="token operator">:</span> options<span class="token punctuation">.</span>wrapX<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ç“¦ç‰‡æ ¼ç½‘</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tileGrid <span class="token operator">=</span> options<span class="token punctuation">.</span>tileGrid <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> options<span class="token punctuation">.</span>tileGrid <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// ç“¦ç‰‡å¤§å°</span>
    <span class="token keyword">const</span> tileSize <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// ç“¦ç‰‡ç¼“å­˜</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tileCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TileCache</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>cacheSize <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// åˆ¤æ–­èŒƒå›´å†…æ˜¯å¦æœ‰å·²ç»loaderçš„åˆ‡ç‰‡</span>
  <span class="token function">forEachLoadedTile</span><span class="token punctuation">(</span><span class="token parameter">projection<span class="token punctuation">,</span> z<span class="token punctuation">,</span> tileRange<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> tileCache <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTileCacheForProjection</span><span class="token punctuation">(</span>projection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tileCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> covered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> tile<span class="token punctuation">,</span> tileCoordKey<span class="token punctuation">,</span> loaded<span class="token punctuation">;</span>
    <span class="token comment">// å¾ªç¯éå†èŒƒå›´å†…çš„åˆ‡ç‰‡</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> x <span class="token operator">=</span> tileRange<span class="token punctuation">.</span>minX<span class="token punctuation">;</span> x <span class="token operator">&lt;=</span> tileRange<span class="token punctuation">.</span>maxX<span class="token punctuation">;</span> <span class="token operator">++</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> y <span class="token operator">=</span> tileRange<span class="token punctuation">.</span>minY<span class="token punctuation">;</span> y <span class="token operator">&lt;=</span> tileRange<span class="token punctuation">.</span>maxY<span class="token punctuation">;</span> <span class="token operator">++</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tileCoordKey <span class="token operator">=</span> <span class="token function">getKeyZXY</span><span class="token punctuation">(</span>z<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
        loaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœcacheé‡Œæœ‰åˆ‡ç‰‡ä¸”ä¸ºloaderå°±è¿”å›ç¼“å­˜åˆ‡ç‰‡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tileCache<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>tileCoordKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          tile <span class="token operator">=</span> <span class="token punctuation">(</span>tileCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
            tileCoordKey
          <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          loaded <span class="token operator">=</span> tile<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> TileState<span class="token punctuation">.</span><span class="token constant">LOADED</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>loaded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            loaded <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>tile<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loaded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          covered <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> covered<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token comment">// è·å–ç“¦ç‰‡, ç±»ä¼¼å‰é¢çš„getImage éœ€è¦å­ç±»æ ¹æ®ä¸åŒçš„æ•°æ®æºè¿›è¡Œå‡½æ•°é‡è½½</span>
  <span class="token function">getTile</span><span class="token punctuation">(</span><span class="token parameter">z<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> pixelRatio<span class="token punctuation">,</span> projection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">abstract</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// è·å–åˆ‡ç‰‡ç½‘æ ¼, å¦‚æœæ²¡æœ‰å°±æ ¹æ®åæ ‡ç³»åˆ›å»º</span>
  <span class="token function">getTileGridForProjection</span><span class="token punctuation">(</span><span class="token parameter">projection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>tileGrid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">getTileGridForProjection</span><span class="token punctuation">(</span>projection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tileGrid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tileCache<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="ol-source-urltile"><a href="#ol-source-urltile" class="header-anchor">#</a> ol/source/UrlTile</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ol/source/UrlTile.js å…³é”®ä»£ç </span>

<span class="token keyword">class</span> <span class="token class-name">UrlTile</span> <span class="token keyword">extends</span> <span class="token class-name">TileSource</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>generateTileUrlFunction_ <span class="token operator">=</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>tileUrlFunction <span class="token operator">===</span> <span class="token class-name">UrlTile</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>tileUrlFunction<span class="token punctuation">;</span>


    <span class="token keyword">this</span><span class="token punctuation">.</span>tileLoadFunction <span class="token operator">=</span> options<span class="token punctuation">.</span>tileLoadFunction<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>tileUrlFunction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>tileUrlFunction <span class="token operator">=</span> options<span class="token punctuation">.</span>tileUrlFunction<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>urls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setUrls</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>urls<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>tileLoadingKeys_ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ç›‘å¬ tile æ”¹å˜äº‹ä»¶</span>
  <span class="token function">handleTileChange</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> tile <span class="token operator">=</span> <span class="token comment">/** @type {import(&quot;../Tile.js&quot;).default} */</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> uid <span class="token operator">=</span> <span class="token function">getUid</span><span class="token punctuation">(</span>tile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> tileState <span class="token operator">=</span> tile<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> type<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tileState <span class="token operator">==</span> TileState<span class="token punctuation">.</span><span class="token constant">LOADING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>tileLoadingKeys_<span class="token punctuation">[</span>uid<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      type <span class="token operator">=</span> TileEventType<span class="token punctuation">.</span><span class="token constant">TILELOADSTART</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>uid <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tileLoadingKeys_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tileLoadingKeys_<span class="token punctuation">[</span>uid<span class="token punctuation">]</span><span class="token punctuation">;</span>
      type <span class="token operator">=</span>
        tileState <span class="token operator">==</span> TileState<span class="token punctuation">.</span><span class="token constant">ERROR</span>
          <span class="token operator">?</span> TileEventType<span class="token punctuation">.</span><span class="token constant">TILELOADERROR</span>
          <span class="token operator">:</span> tileState <span class="token operator">==</span> TileState<span class="token punctuation">.</span><span class="token constant">LOADED</span>
          <span class="token operator">?</span> TileEventType<span class="token punctuation">.</span><span class="token constant">TILELOADEND</span>
          <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">!=</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TileSourceEvent</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> tile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ç”¨äºæ„é€ åˆ‡ç‰‡è¯·æ±‚çš„URL å­ç±»ä¼šé‡å†™è¯¥å‡½æ•°</span>
  <span class="token comment">// å¦‚æœæ²¡æœ‰é‡å†™ä¼šåœ¨setUrlsä½¿ç”¨é»˜è®¤æ¨¡ç‰ˆ</span>
  <span class="token function">tileUrlFunction</span><span class="token punctuation">(</span><span class="token parameter">tileCoord<span class="token punctuation">,</span> pixelRatio<span class="token punctuation">,</span> projection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">setUrls</span><span class="token punctuation">(</span><span class="token parameter">urls</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>urls <span class="token operator">=</span> urls<span class="token punctuation">;</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> urls<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœä¸ºtrue, ä½¿ç”¨é»˜è®¤æ¨¡ç‰ˆ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>generateTileUrlFunction_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setTileUrlFunction</span><span class="token punctuation">(</span><span class="token function">createFromTemplates</span><span class="token punctuation">(</span>urls<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tileGrid<span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="ol-source-tileimage"><a href="#ol-source-tileimage" class="header-anchor">#</a> ol/source/TileImage</h4> <p>åŒ…åŠäº†åˆ‡ç‰‡çš„åˆ›å»ºä»¥åŠç¼“å­˜å¤„ç†</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ol/source/TileImage.js å…³é”®ä»£ç </span>

<span class="token keyword">class</span> <span class="token class-name">TileImage</span> <span class="token keyword">extends</span> <span class="token class-name">UrlTile</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ImageTileæ˜¯ ol/ImageTile.js</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tileClass <span class="token operator">=</span>
      options<span class="token punctuation">.</span>tileClass <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> options<span class="token punctuation">.</span>tileClass <span class="token operator">:</span> ImageTile<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// è·å–åˆ‡ç‰‡çš„æ–¹æ³•</span>
  <span class="token function">getTile</span><span class="token punctuation">(</span><span class="token parameter">z<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> pixelRatio<span class="token punctuation">,</span> projection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> sourceProjection <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getProjection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ¤æ–­åæ ‡ç³»æ˜¯å¦éœ€è¦è½¬æ¢</span>
    <span class="token comment">// projectionå‚æ•°æŒ‡çš„æ˜¯viewçš„projection</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token operator">!</span><span class="token constant">ENABLE_RASTER_REPROJECTION</span> <span class="token operator">||</span>
      <span class="token operator">!</span>sourceProjection <span class="token operator">||</span>
      <span class="token operator">!</span>projection <span class="token operator">||</span>
      <span class="token function">equivalent</span><span class="token punctuation">(</span>sourceProjection<span class="token punctuation">,</span> projection<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTileInternal</span><span class="token punctuation">(</span>
        z<span class="token punctuation">,</span>
        x<span class="token punctuation">,</span>
        y<span class="token punctuation">,</span>
        pixelRatio<span class="token punctuation">,</span>
        sourceProjection <span class="token operator">||</span> projection
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// è·å– ol/ImageTile ç±»</span>
  <span class="token function">getTileInternal</span><span class="token punctuation">(</span><span class="token parameter">z<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> pixelRatio<span class="token punctuation">,</span> projection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> tile <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> tileCoordKey <span class="token operator">=</span> <span class="token function">getKeyZXY</span><span class="token punctuation">(</span>z<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>tileCache<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>tileCoordKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// åˆ›å»ºtile, å¹¶å­˜å…¥ç¼“å­˜</span>
      tile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createTile_</span><span class="token punctuation">(</span>z<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> pixelRatio<span class="token punctuation">,</span> projection<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>tileCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>tileCoordKey<span class="token punctuation">,</span> tile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      tile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tileCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tileCoordKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> tile<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// åˆ›å»ºåˆ‡ç‰‡(ol/ImageTile)</span>
  <span class="token function">createTile_</span><span class="token punctuation">(</span><span class="token parameter">z<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> pixelRatio<span class="token punctuation">,</span> projection<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> tileCoord <span class="token operator">=</span> <span class="token punctuation">[</span>z<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> urlTileCoord <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTileCoordForTileUrlFunction</span><span class="token punctuation">(</span>
      tileCoord<span class="token punctuation">,</span>
      projection
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> tileUrl <span class="token operator">=</span> urlTileCoord
      <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tileUrlFunction</span><span class="token punctuation">(</span>urlTileCoord<span class="token punctuation">,</span> pixelRatio<span class="token punctuation">,</span> projection<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> tile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">this<span class="token punctuation">.</span>tileClass</span><span class="token punctuation">(</span>
      tileCoord<span class="token punctuation">,</span>
      tileUrl <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> TileState<span class="token punctuation">.</span><span class="token constant">IDLE</span> <span class="token operator">:</span> TileState<span class="token punctuation">.</span><span class="token constant">EMPTY</span><span class="token punctuation">,</span>
      tileUrl <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> tileUrl <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>crossOrigin<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>tileLoadFunction<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>tileOptions
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    tile<span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
    tile<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>EventType<span class="token punctuation">.</span><span class="token constant">CHANGE</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleTileChange</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> tile<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="ol-source-tilearcgisrest"><a href="#ol-source-tilearcgisrest" class="header-anchor">#</a> ol/source/TileArcGISRest</h4> <p>å…·ä½“ç”¨äºå®ä¾‹åŒ–çš„ source ç±», ä¸»è¦é‡å†™çˆ¶ç±»çš„ tileUrlFunction å‡½æ•°, æ ¹æ®å®é™…æƒ…å†µ, æ„é€ åˆ‡ç‰‡ URL</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">TileArcGISRest</span> <span class="token keyword">extends</span> <span class="token class-name">TileImage</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>

  <span class="token comment">// é‡å†™çˆ¶ç±»å‡½æ•°, æ„å»ºè‡ªå·±çš„URLæ‹¼æ¥å‡½æ•°</span>
  <span class="token function">tileUrlFunction</span><span class="token punctuation">(</span><span class="token parameter">tileCoord<span class="token punctuation">,</span> pixelRatio<span class="token punctuation">,</span> projection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> tileGrid <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTileGrid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tileGrid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      tileGrid <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTileGridForProjection</span><span class="token punctuation">(</span>projection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>tileGrid<span class="token punctuation">.</span><span class="token function">getResolutions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> tileCoord<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pixelRatio <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>hidpi_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      pixelRatio <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> tileExtent <span class="token operator">=</span> tileGrid<span class="token punctuation">.</span><span class="token function">getTileCoordExtent</span><span class="token punctuation">(</span>tileCoord<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tmpExtent_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> tileSize <span class="token operator">=</span> <span class="token function">toSize</span><span class="token punctuation">(</span>tileGrid<span class="token punctuation">.</span><span class="token function">getTileSize</span><span class="token punctuation">(</span>tileCoord<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tmpSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pixelRatio <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      tileSize <span class="token operator">=</span> <span class="token function">scaleSize</span><span class="token punctuation">(</span>tileSize<span class="token punctuation">,</span> pixelRatio<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tmpSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> baseParams <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token string">'F'</span><span class="token operator">:</span> <span class="token string">'image'</span><span class="token punctuation">,</span>
      <span class="token string">'FORMAT'</span><span class="token operator">:</span> <span class="token string">'PNG32'</span><span class="token punctuation">,</span>
      <span class="token string">'TRANSPARENT'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">assign</span><span class="token punctuation">(</span>baseParams<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>params_<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRequestUrl_</span><span class="token punctuation">(</span>
      tileCoord<span class="token punctuation">,</span>
      tileSize<span class="token punctuation">,</span>
      tileExtent<span class="token punctuation">,</span>
      pixelRatio<span class="token punctuation">,</span>
      projection<span class="token punctuation">,</span>
      baseParams
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getRequestUrl_</span><span class="token punctuation">(</span>
    <span class="token parameter">tileCoord<span class="token punctuation">,</span>
    tileSize<span class="token punctuation">,</span>
    tileExtent<span class="token punctuation">,</span>
    pixelRatio<span class="token punctuation">,</span>
    projection<span class="token punctuation">,</span>
    params</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> urls <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>urls<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>urls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> srid <span class="token operator">=</span> projection<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    params<span class="token punctuation">[</span><span class="token string">'SIZE'</span><span class="token punctuation">]</span> <span class="token operator">=</span> tileSize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">','</span> <span class="token operator">+</span> tileSize<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    params<span class="token punctuation">[</span><span class="token string">'BBOX'</span><span class="token punctuation">]</span> <span class="token operator">=</span> tileExtent<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    params<span class="token punctuation">[</span><span class="token string">'BBOXSR'</span><span class="token punctuation">]</span> <span class="token operator">=</span> srid<span class="token punctuation">;</span>
    params<span class="token punctuation">[</span><span class="token string">'IMAGESR'</span><span class="token punctuation">]</span> <span class="token operator">=</span> srid<span class="token punctuation">;</span>
    params<span class="token punctuation">[</span><span class="token string">'DPI'</span><span class="token punctuation">]</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>
      params<span class="token punctuation">[</span><span class="token string">'DPI'</span><span class="token punctuation">]</span> <span class="token operator">?</span> params<span class="token punctuation">[</span><span class="token string">'DPI'</span><span class="token punctuation">]</span> <span class="token operator">*</span> pixelRatio <span class="token operator">:</span> <span class="token number">90</span> <span class="token operator">*</span> pixelRatio
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> url<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>urls<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      url <span class="token operator">=</span> urls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token function">modulo</span><span class="token punctuation">(</span><span class="token function">tileCoordHash</span><span class="token punctuation">(</span>tileCoord<span class="token punctuation">)</span><span class="token punctuation">,</span> urls<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      url <span class="token operator">=</span> urls<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> modifiedUrl <span class="token operator">=</span> url
      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">MapServer\/?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'MapServer/export'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">ImageServer\/?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'ImageServer/exportImage'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">appendParams</span><span class="token punctuation">(</span>modifiedUrl<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="ol-imagetile"><a href="#ol-imagetile" class="header-anchor">#</a> ol/ImageTile</h4> <p>getTileInternal å‡½æ•°å¾—åˆ°çš„ ImageTile å¦‚æœ state ä¸º IDLE ä¼šè¢«æ¨å…¥ tileQueue, åœ¨ handlePostRender çš„æ—¶å€™è°ƒç”¨ load æ–¹æ³•, ç„¶åç›‘å¬ image æ ‡ç­¾æ˜¯å¦åŠ è½½åˆ°äº†å›¾ç‰‡æ•°æ®, å½“åŠ è½½å®Œæˆçš„æ—¶å€™è§¦å‘ change å‡½æ•°.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">ImageTile</span> <span class="token keyword">extends</span> <span class="token class-name">Tile</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>image_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">==</span> TileState<span class="token punctuation">.</span><span class="token constant">ERROR</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> TileState<span class="token punctuation">.</span><span class="token constant">IDLE</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>image_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>crossOrigin_ <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>image_<span class="token punctuation">.</span>crossOrigin <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>crossOrigin_<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">==</span> TileState<span class="token punctuation">.</span><span class="token constant">IDLE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> TileState<span class="token punctuation">.</span><span class="token constant">LOADING</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">changed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tileLoadFunction_</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>src_<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>unlisten_ <span class="token operator">=</span> <span class="token function">listenImage</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>image_<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleImageLoad_</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleImageError_</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">handleImageLoad_</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>image_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>image<span class="token punctuation">.</span>naturalWidth <span class="token operator">&amp;&amp;</span> image<span class="token punctuation">.</span>naturalHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> TileState<span class="token punctuation">.</span><span class="token constant">LOADED</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> TileState<span class="token punctuation">.</span><span class="token constant">EMPTY</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unlistenImage_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">changed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="çŸ¢é‡æ•°æ®-ol-source-vector"><a href="#çŸ¢é‡æ•°æ®-ol-source-vector" class="header-anchor">#</a> çŸ¢é‡æ•°æ®(ol/source/Vector)</h3> <p>çŸ¢é‡æ•°æ®</p> <p>çŸ¢é‡å›¾å±‚ä¼šåœ¨ prepareFrame é˜¶æ®µåŠ è½½å¤–éƒ¨çŸ¢é‡æ•°æ®</p> <p><img src="/Blog/assets/img/09.039d69f2.png" alt="image"></p> <h4 id="ol-source-vector"><a href="#ol-source-vector" class="header-anchor">#</a> ol/source/Vector</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">VectorSource</span> <span class="token keyword">extends</span> <span class="token class-name">Source</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">opt_options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token comment">// çŸ¢é‡æ•°æ®çš„urlå’Œè¦ä½¿ç”¨çš„format(å¯¹åº”ç±»å‹çš„è§£æå™¨)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>url_ <span class="token operator">=</span> options<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>format_ <span class="token operator">=</span> options<span class="token punctuation">.</span>format<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>loader <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>loader_ <span class="token operator">=</span> options<span class="token punctuation">.</span>loader<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>url_ <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœurlä¸ä¸ºç©º, ä½¿ç”¨featureloaderå·¥å…·ç±»åŠ è½½æ•°æ®</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>loader_ <span class="token operator">=</span> <span class="token function">xhr</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>url_<span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>format_<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">loadFeatures</span><span class="token punctuation">(</span><span class="token parameter">extent<span class="token punctuation">,</span> resolution<span class="token punctuation">,</span> projection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> loadedExtentsRtree <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>loadedExtentsRtree_<span class="token punctuation">;</span>
    <span class="token keyword">const</span> extentsToLoad <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">strategy_</span><span class="token punctuation">(</span>extent<span class="token punctuation">,</span> resolution<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ii <span class="token operator">=</span> extentsToLoad<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ii<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> extentToLoad <span class="token operator">=</span> extentsToLoad<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> alreadyLoaded <span class="token operator">=</span> loadedExtentsRtree<span class="token punctuation">.</span><span class="token function">forEachInExtent</span><span class="token punctuation">(</span>
        extentToLoad<span class="token punctuation">,</span>
        <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">containsExtent</span><span class="token punctuation">(</span>object<span class="token punctuation">.</span>extent<span class="token punctuation">,</span> extentToLoad<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>alreadyLoaded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>
          <span class="token keyword">new</span> <span class="token class-name">VectorSourceEvent</span><span class="token punctuation">(</span>VectorEventType<span class="token punctuation">.</span><span class="token constant">FEATURESLOADSTART</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loader_</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
          <span class="token keyword">this</span><span class="token punctuation">,</span>
          extentToLoad<span class="token punctuation">,</span>
          resolution<span class="token punctuation">,</span>
          projection<span class="token punctuation">,</span>
          <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">features</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>
              <span class="token keyword">new</span> <span class="token class-name">VectorSourceEvent</span><span class="token punctuation">(</span>
                VectorEventType<span class="token punctuation">.</span><span class="token constant">FEATURESLOADEND</span><span class="token punctuation">,</span>
                <span class="token keyword">undefined</span><span class="token punctuation">,</span>
                features
              <span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>
              <span class="token keyword">new</span> <span class="token class-name">VectorSourceEvent</span><span class="token punctuation">(</span>VectorEventType<span class="token punctuation">.</span><span class="token constant">FEATURESLOADERROR</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        loadedExtentsRtree<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>extentToLoad<span class="token punctuation">,</span> <span class="token punctuation">{</span>extent<span class="token operator">:</span> extentToLoad<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>loader_ <span class="token operator">!==</span> <span class="token constant">VOID</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// æ·»åŠ feature, è§¦å‘change</span>
  <span class="token function">addFeatures</span><span class="token punctuation">(</span><span class="token parameter">features</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addFeaturesInternal</span><span class="token punctuation">(</span>features<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">changed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h4 id="ol-featureloader"><a href="#ol-featureloader" class="header-anchor">#</a> ol/featureloader</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">xhr</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> format</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">extent<span class="token punctuation">,</span> resolution<span class="token punctuation">,</span> projection<span class="token punctuation">,</span> success<span class="token punctuation">,</span> failure</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token function">loadFeaturesXhr</span><span class="token punctuation">(</span>
      url<span class="token punctuation">,</span>
      format<span class="token punctuation">,</span>
      extent<span class="token punctuation">,</span>
      resolution<span class="token punctuation">,</span>
      projection<span class="token punctuation">,</span>
      <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">features<span class="token punctuation">,</span> dataProjection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>success <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">success</span><span class="token punctuation">(</span>features<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        source<span class="token punctuation">.</span><span class="token function">addFeatures</span><span class="token punctuation">(</span>features<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      failure <span class="token operator">?</span> failure <span class="token operator">:</span> <span class="token constant">VOID</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="source-change"><a href="#source-change" class="header-anchor">#</a> Source change</h3> <p>çœ‹å®Œä¸Šé¢ä¸‰ç§ç±»å‹å›¾å±‚çš„ source éƒ¨åˆ†, æˆ‘ä»¬è¿˜ç•™æ„åˆ°æ¯æ¬¡åœ¨è·å–å®Œæ•°æ®çš„æ—¶å€™éƒ½ä¼šè§¦å‘ change å‡½æ•°.</p> <p>åŸå› æ˜¯ renderer ä¼šå¯¹çš„ image è¿›è¡Œç›‘å¬(vector ç±»å‹çš„ source ä¸ä¼š, å› ä¸ºä¸éœ€è¦ image)</p> <p>ä»¥ ol/renderer/Layer ä¸ºä¾‹:</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">loadImage</span><span class="token punctuation">(</span><span class="token parameter">image</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> imageState <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>imageState <span class="token operator">!=</span> ImageState<span class="token punctuation">.</span><span class="token constant">LOADED</span> <span class="token operator">&amp;&amp;</span> imageState <span class="token operator">!=</span> ImageState<span class="token punctuation">.</span><span class="token constant">ERROR</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœstateä¸æ˜¯LOADEDæˆ–ERROR å°±ä¼šç›‘å¬change</span>
      image<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>EventType<span class="token punctuation">.</span><span class="token constant">CHANGE</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>boundHandleImageChange_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>imageState <span class="token operator">==</span> ImageState<span class="token punctuation">.</span><span class="token constant">IDLE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      image<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      imageState <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> imageState <span class="token operator">==</span> ImageState<span class="token punctuation">.</span><span class="token constant">LOADED</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>åŒç†, åœ¨ boundHandleImageChange_ å‡½æ•°ä¸­ä¹Ÿä¼šè°ƒç”¨ this.change è§¦å‘ layerGroup ç›‘å¬ layer çš„ change äº‹ä»¶, æœ€åè°ƒç”¨ layerGroup çš„ this.change ,map ç›‘å¬åˆ° layerGroup å˜åŒ–äº†, é‡æ–°æ‰§è¡Œ render å‡½æ•°, å°†æ•°æ®æ¸²æŸ“åˆ°åœ°å›¾ä¸Š.</p> <h3 id="view-change"><a href="#view-change" class="header-anchor">#</a> View change</h3> <p>é™¤äº† source ä¼š change, å½“ç”¨æˆ·æ“ä½œåœ°å›¾çš„æ—¶å€™. View ä¹Ÿä¼šè§¦å‘ change äº‹ä»¶, å¯¼è‡´ map é‡æ–°æ‰§è¡Œ render å‡½æ•°.</p> <p>å¯¹ä¸‰ç§ç±»å‹çš„å›¾å±‚, ä¹Ÿä¼šæœ‰ä¸‰ç§ä¸åŒçš„å¤„ç†è¿‡ç¨‹</p> <p><img src="/Blog/assets/img/11.c854a198.png" alt="image"></p> <h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="header-anchor">#</a> æ€»ç»“</h2> <p>æœ€å, æ•´åˆç»˜åˆ¶äº†ä¸€å¼ å®Œæ•´çš„ UML å›¾å’Œ map åŠ è½½å›¾å±‚çš„æµç¨‹å›¾</p> <p>UML å›¾</p> <p><img src="/Blog/assets/img/12.87223d2f.png" alt="image"></p> <p>æµç¨‹å›¾</p> <p><img src="/Blog/assets/img/13.31d94b33.png" alt="image"></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/29/2023, 2:39:52 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/Blog/dailyRecord/gis/OLSourceCode1.html" class="prev">
        OpenLayers æºç åˆ†æ(ä¸Šç¯‡)
      </a></span> <span class="next"><a href="/Blog/dailyRecord/gis/ArcgisAPI.html">
        Arcgis API
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/Blog/assets/js/app.d6f4b6a2.js" defer></script><script src="/Blog/assets/js/2.fd75a44f.js" defer></script><script src="/Blog/assets/js/9.e1456e0e.js" defer></script>
  </body>
</html>
